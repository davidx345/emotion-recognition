<!DOCTYPE html>
<html>
<head>
<title>Emotion Recognition</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<style>
body,h1 {font-family: "Courier New", monospace}
body, html {height: 100%; overflow-y: scroll;}
.bgimg {
  background-image: url('https://images.unsplash.com/photo-1483401757487-2ced3fa77952?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1173&q=80');
  min-height: 100%;
  background-position: center;
  background-size: cover;
  background-attachment: fixed;
}
.upload-section {
  background-color: rgba(0,0,0,0.8);
  padding: 20px;
  border-radius: 10px;
  margin: 20px auto;
  max-width: 600px;
}
#videoElement {
  width: 100%;
  max-width: 500px;
  border: 2px solid white;
  border-radius: 10px;
}
.emotion-result {
  font-size: 24px;
  font-weight: bold;
  color: #4CAF50;
  margin-top: 10px;
}
</style>
</head>
<body>

<div class="bgimg w3-animate-opacity w3-text-white">
  <div style="text-align: center; padding-top: 20px;">
    <h1 class="w3-jumbo w3-animate-top">Emotion&nbsp;Detection</h1>
    <hr class="w3-border-grey" style="margin:auto;width:70%">
  </div>
  
  <div class="upload-section">
    <h2>Real-Time Webcam Detection</h2>
    <video id="videoElement" autoplay playsinline></video>
    <div class="emotion-result" id="emotionResult">Emotion: Waiting...</div>
    <button id="startWebcam" class="w3-button w3-green w3-margin-top">Start Webcam</button>
    <button id="stopWebcam" class="w3-button w3-red w3-margin-top" style="display:none;">Stop Webcam</button>
  </div>

  <div class="upload-section">
    <h2>Upload Image for Emotion Detection</h2>
    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
        <input type="text" name="name" placeholder="Enter your name" required class="w3-input w3-border">
        <input type="file" name="file" accept="image/*" required class="w3-input w3-border w3-margin-top">
        <button type="submit" class="w3-button w3-black w3-margin-top">Upload & Detect Emotion</button>
    </form>
  </div>

  <div class="upload-section">
    <h2>Recent Detections</h2>
    <ul class="w3-ul">
        {% for record in records %}
        <li>{{ record.name }} - {{ record.emotion }} at {{ record.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</li>
        {% endfor %}
    </ul>
  </div>
</div>

<script>
const video = document.getElementById('videoElement');
const emotionResult = document.getElementById('emotionResult');
const startBtn = document.getElementById('startWebcam');
const stopBtn = document.getElementById('stopWebcam');
let stream = null;
let intervalId = null;

startBtn.addEventListener('click', async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        
        // Capture and send frames every 2 seconds
        intervalId = setInterval(captureAndDetect, 2000);
    } catch (err) {
        alert('Error accessing webcam: ' + err.message);
    }
});

stopBtn.addEventListener('click', () => {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
    if (intervalId) {
        clearInterval(intervalId);
    }
    startBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    emotionResult.textContent = 'Emotion: Stopped';
});

async function captureAndDetect() {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg');
    
    try {
        const response = await fetch('/detect_webcam', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ image: imageData })
        });
        
        const data = await response.json();
        if (data.emotion) {
            emotionResult.textContent = 'Emotion: ' + data.emotion;
        }
    } catch (err) {
        console.error('Detection error:', err);
    }
}
</script>

</body>
</html>